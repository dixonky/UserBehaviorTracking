<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <script src="timers.js"></script>
    <script src="keys.js"></script>
    <script src="heatmap.js"></script>
    <link rel="stylesheet" href="style.css">
    <title>Site Statistics</title>
</head>

<body>
    <script type="text/javascript">
        //JS setup functions
        heatmapSetup();
        
        //Global variables
        var body = document.getElementsByTagName("BODY")[0];
        var startTime, startTimeMilli, elapTime, diffTime, time, secs;
        var mouEntTime, mouLeaTime, mouDiffTime, mouSecs;
        var hoverID, leaveID;
        let eleTimes = new Map();
        let clicks = new Map();
        let mouseMove = new Map();
        
        //
        var timeStartCon = document.createElement('div');
        var timeNowCon = document.createElement('div');
        var timeElapCon = document.createElement('div');
        var mouCon = document.createElement('div');
        var clickCon = document.createElement('div');
        var divClickCon = document.createElement('div');
        var divHoverCon = document.createElement('div');
        var keyCon = document.createElement('div');
        var keyAllCon = document.createElement('div');
        var logBut = document.createElement('button');
        var cliBut = document.createElement('button');
        var mouBut = document.createElement('button');
        var resTab = document.createElement('table');
        
        timeStartCon.setAttribute("id", "time-start-container");
        timeNowCon.setAttribute("id", "time-now-container");
        timeNowCon.innerHTML = "Current Time: ";
        timeElapCon.setAttribute("id", "time-elap-container");
        timeElapCon.innerHTML = "Elapsed Time: ";
        mouCon.setAttribute("id", "mouse-container");
        mouCon.innerHTML = "Mouse Location: ";
        clickCon.setAttribute("id", "click-container");
        clickCon.innerHTML = "Click Location: ";
        divClickCon.setAttribute("id", "div-click-container");
        divClickCon.innerHTML = "Element Clicked: ";
        divHoverCon.setAttribute("id", "div-hover-container");
        divHoverCon.innerHTML = "Element Hovered: ";
        keyCon.setAttribute("id", "key-container");
        keyCon.innerHTML = "Last Key Entered: ";
        keyAllCon.setAttribute("id", "key-all-container");
        keyAllCon.innerHTML = "All Keys Entered: ";
        
        logBut.setAttribute("id", "logs-button");
        logBut.innerHTML = "Logs";
        logBut.setAttribute("class", "button");
        cliBut.setAttribute("id", "clicks-button");
        cliBut.innerHTML = "Show Clicks";
        cliBut.setAttribute("class", "button");
        mouBut.setAttribute("id", "mouse-button");
        mouBut.innerHTML = "Track Mouse";
        mouBut.setAttribute("class", "button");
        
        resTab.setAttribute("id", "results-table");
        var row1 = resTab.insertRow(-1);
        var resTimes = row1.insertCell(0);
        resTimes.setAttribute("class", "res");
        resTimes.setAttribute("id", "results-times");
        var resClicks = row1.insertCell(1);
        resClicks.setAttribute("class", "res");
        resClicks.setAttribute("id", "results-clicks");
        
        
        body.appendChild(timeStartCon);
        body.appendChild(timeNowCon);
        body.appendChild(timeElapCon);
        body.appendChild(document.createElement('br'));
        body.appendChild(mouCon);
        body.appendChild(clickCon);
        body.appendChild(document.createElement('br'));
        body.appendChild(divClickCon);
        body.appendChild(divHoverCon);
        body.appendChild(document.createElement('br'));
        body.appendChild(keyCon);
        body.appendChild(keyAllCon);
        body.appendChild(document.createElement('br'));
        body.appendChild(logBut);
        body.appendChild(cliBut);
        body.appendChild(mouBut);
        body.appendChild(document.createElement('br'));
        body.appendChild(resTab);
        
        
        //Time on site functions
        startTime = performance.now();
        startTimeMilli = performance.now();
        time = "Start " + getTime();
        timeStartCon.textContent = time;
        time = "Current " + getTime();
        timeNowCon.textContent = time;
        setInterval(function() {
            time = "Current " + getTime();
            timeNowCon.textContent = time;
        }, 1000);
        setInterval(function() {
            elapTime = performance.now();
            diffTime = elapTime - startTime;
            diffTime /= 1000;
            secs = Math.round(diffTime);
            timeElapCon.textContent = ("Elapsed Time: " + secs);
        }, 1000);
        
        
        //Add events to individual elements
        document.querySelectorAll('*').forEach(function(node) {
            node.addEventListener("click", (evt) => {
                var loc = (evt.pageX + " " + evt.pageY);
                var locTime = getTimeClicks();
                clicks.set(locTime, loc);
                clickCon.textContent = ("Click Location: " + evt.pageX + " " + evt.pageY); 
            });
            node.addEventListener("mouseover", (evt) => {
                hoverID = evt.target.id;
                if(hoverID){mouEntTime = performance.now();}
                if(!hoverID) {hoverID = "None";}
                divHoverCon.textContent = ("Element Hovered: " + hoverID);
            });
            node.addEventListener("mouseleave", (evt) => {
                leaveID = evt.target.id;
                if (hoverID == leaveID) {
                    mouLeaTime = performance.now();
                    mouDiffTime = mouLeaTime - mouEntTime;
                    mouDiffTime = Math.round(mouDiffTime);
                    mouDiffTime /= 1000;
                    if(eleTimes.has(leaveID)){
                        eleTimes.set(leaveID, (eleTimes.get(leaveID)+mouDiffTime));
                    }
                    else {
                        eleTimes.set(leaveID, mouDiffTime);
                    }
                }
            });
        });
        
        
        //Add events to the whole document
        document.addEventListener("mousemove", (evt) => {
            addTime(evt.pageX, evt.pageY);
            var loc = (evt.pageX + " " + evt.pageY);
            var locTime = performance.now();
            mouseMove.set(locTime, loc);
            mouCon.textContent = ("Mouse Location: " + evt.pageX + " " + evt.pageY);
        });
        
        document.addEventListener("click", (evt) => {
            var clickedid = evt.target.id;
            if(!clickedid) {clickedid = "None";}
            divClickCon.textContent = ("Element Clicked: " + clickedid);
        });
        
        document.addEventListener("keypress", (evt) => {
            var key =  getKey(evt.shiftKey, evt.which);
            var textnode = document.createTextNode(key);
            keyCon.textContent = ("Last Key Entered: " + key);
            keyAllCon.appendChild(textnode);
        });
        
        
        //Add events to the buttons
        logBut.addEventListener("click", (evt) => {
            resTimes.innerHTML = '';
            var textnode = document.createTextNode('Time Spent on Each Element:');
            resTimes.appendChild(textnode);
            resTimes.appendChild(document.createElement('br'));
            let sortedTimes = new Map([...eleTimes].sort());
            for (let [key, value] of sortedTimes.entries()) {
                var textnode = document.createTextNode("\u00a0\u00a0\u00a0"+key + ' = ' + value.toFixed(3));
                resTimes.appendChild(textnode);
                resTimes.appendChild(document.createElement('br'));
            }
            resClicks.innerHTML = '';
            var textnode = document.createTextNode('Click Log:');
            resClicks.appendChild(textnode);
            resClicks.appendChild(document.createElement('br'));
            let sortedClicks = new Map([...clicks].sort());
            for (let [key, value] of sortedClicks.entries()) {
                var textnode = document.createTextNode("\u00a0\u00a0\u00a0"+value +" @ " + key);
                resClicks.appendChild(textnode);
                resClicks.appendChild(document.createElement('br'));
            }
        });
        
        cliBut.addEventListener("click", (evt) => {
            cliMap = document.createElement('div');
            cliMap.setAttribute("id", "clickmap-overlay");
            body.appendChild(cliMap);
            let count = 0;
            for (let [key, value] of clicks.entries()) {
                count += 1;
                var coor = value.split(" ");
                let cli = document.createElement('div');
                cli.setAttribute("class", "clickmap-container");
                var sty = 'left:'+(coor[0]-10)+'px;top:'+(coor[1]-10)+'px;';
                cli.setAttribute("style", sty)
                cli.innerHTML = count;
                document.getElementById("clickmap-overlay").appendChild(cli);
            }
            setTimeout(function() {
                document.getElementById("clickmap-overlay").remove();
            }, 5000);
        });
        
        mouBut.addEventListener("click", (evt) => {
            cliMap = document.createElement('div');
            cliMap.setAttribute("id", "clickmap-overlay");
            body.appendChild(cliMap);
            var prevTime = startTimeMilli;
            let delayTot = 0;
            let count = 0;
            for (let [key, value] of mouseMove.entries()) {
                count += 1;
                if (count == 361){count = 0;}
                let coor = value.split(" ");                
                let cli = document.createElement('div');
                cli.setAttribute("class", "mousemap-container");
                var sty = 'left:'+(coor[0]-10)+'px;top:'+(coor[1]-10)+'px;' + 
                    'background-color: hsl('+count+', 100%, 50%);';
                cli.setAttribute("style", sty);
                let nowTime = key;
                let delay = nowTime - prevTime;
                delayTot += delay;
                function timer(){ 
                    setTimeout(()=>{
                        document.getElementById("clickmap-overlay").appendChild(cli);
                    }, delayTot);
                }
                timer();
                prevTime = nowTime;
            }
            setTimeout(function() {
                document.getElementById("clickmap-overlay").remove();
            }, 3000 + delayTot);
        });
        
    </script>
 
</body>
<footer>
</footer>
</html>
